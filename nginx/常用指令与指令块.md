<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [常用指令与指令块](#常用指令与指令块)
  - [指令 directive](#指令-directive)
  - [指令块 directiveBlock](#指令块-directiveblock)
  - [http模块](#http模块)
  - [upstream模块](#upstream模块)
  - [server模块](#server模块)
  - [location模块](#location模块)

<!-- /code_chunk_output -->

# 常用指令与指令块

- `http`

- `server`

- `upstream`

- `location`

这四个模块是常用的模块，一般我们有这四个指令就可以将网站文件通过端口映射出来。

```nginx
# 指令块
http {
        # 指令
        # mime.type 含有很多的文件后缀名，和文件关系对照表。
        include mime.types;
        upstream feup {
                server 127.0.0.1:3000;
        }
        server {
                listen 80;
                server_name localhost;

                location / {
                    root /var/www/html;
                    index index.html index.htm;
                }
        }
        server {
            listen 3000;
            server_name localhost;

            location / {
                root /var/www/feup;
                index index.html;

                try_files $uri /index.html @router;
            }
        }
        server {
                listen 80;
                server_name feup.kaikeba.com;

                location / {
                        proxy_pass   http://feup;
                        proxy_http_version 1.1;
                        proxy_set_header Upgrade $http_upgrade;
                        proxy_set_header Connection $connection_upgrade;
                }
        }
}
```

上面的配置文件包含了一些最简单并常用的访问配置。分别对应下面三个地址：

```bash
# nginx的默认访问地址，对应/var/www/html目录
http://127.0.0.1

# feup打包后的访问地址，对应/var/www/feup目录，而且做了路由重定向
http://127.0.0.1:3000

# 我们将feup.kaikeba.com映射到了3000端口，接下来做一个本地hosts映射就可以通过这个地址来访问feup了
http://feup.kaikeba.com
```

## 指令 directive

```nginx
include mime.types;
```

指令可以接受多个参数，参数用空格分割。

可以将它看成 js 里的函数一样。

```js
// 伪代码
function directive(feature, ...props) {
  return feature(...props);
}
```

两个指令之间，使用分号作为分隔符。所以也可以像下面这样写

> 通常不建议这样，因为可读性会变得很差。

```nginx
location ~* \.(gif|jpeg|png|jpg)$ {
        expires 3m; proxy_cache my_zone;
}
```

## 指令块 directiveBlock

后面跟大括号的就是指令块，它的作用就是将多条指令组合在一起。

有些指令块可以有名字，有些是没有名字的。而且指令块内也可以包含其他指令块。

至于什么时候有名字，什么时候不带名字，这个是由提供这个指令块的模块来决定的，可以决定这个指令块有多少个参数。

```nginx
http {
        # upstream 把 server指令 放在了 feup 指令块下面。
        upstream feup {
                server 127.0.0.1:3000;
        }
}
```

## http模块

代表在http模块内的所有指令和指令块，都是由http模块去解析去执行的。

## upstream模块

代表着上游服务，比如我们有个node服务、tomcat服务。需要与这些服务交互的时候可以定义一个upstream。

## server模块

用于对应一个域名或者一组域名。

## location模块

url表达式，针对不同url做出不同的指令动作。

