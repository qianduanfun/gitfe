#转介绍活动

目标：迅速拉新裂变，生成海报拉新用户，依托微信公众号


功能点：微信授权，分享，二维码canvas转img，移动端图片的loading处理，快推埋点的处理，gio埋点的处理


###移动端布局适配

处理类似布局的时候 中间每个item的宽度都要使用百分比，使用rem换算可能会被挤下去，rem换算可以在调整间距时使用，大模块的排列最好使用百分比

![20200103110850](http://f.shudong.wang/starkwang/20200103110850.png)


###微信授权

1 获取url中的wxcode，如果链接中不存在，则跳转到第三方微信授权的链接

![20200103141753](http://f.shudong.wang/starkwang/20200103141753.png)

2 授权之后回来会带有wxcode 拿到wxcode去请求 open/wechat 接口 获取微信用户头像名字等一系列参数



###微信分享

1 判断是否在微信环境下，如果是则初始化微信需要分享出去的url与成功的回调方法以及文案等
![20200103154543](http://f.shudong.wang/starkwang/20200103154543.png)

```
  wxShare = () => {
    let that = this;
    let checkUrlUnionid = changeUrlArg(
      window.location.href,
      "source_unionid",
      getStorage("unionId")
    ); // 更换连接中的source_unionid参数的值，如连接中没有source_unionid，则直接添加;
    let shareUrl = changeUrlArg(
      checkUrlUnionid,
      "pay_marketing_plan_id",
      pay_marketing_plan_id
    );
    let shareUrlEnd = this.state.buyedFlag ? shareUrl : window.location.href;
    setTimeout(function() {
      isWeChat() &&
        share.init(
          shareUrlEnd,
          that.venueSignInFn,
          that.isWxServiceFn,
          that.kuickDealonBehaviour,
          "【开年老带新 双双有惊喜】最高奖iPhone 11 Pro！",
          "开课吧新年好礼！人气口碑课程，助你走上人生巅峰！"
        );
    }, 100);
  };
```
2 下载微信官方的weixin-js-sdk包，注意如果是服务端需要手动用script的方法引入

官方下载地址：http://res.wx.qq.com/open/js/jweixin-1.6.0.js





3 初始化方法，调用微信的js接口签名校验工具

调用微信公众号后端开发的api接口
```
import request from "../utils/request";
import wx from "weixin-js-sdk";
import { urlDelP } from "../utils";

export const share = {
  title: "【推荐赢好礼，一起来加薪】",
  desc: "拉新1人即得10G职场资料包，还有京东购物卡等你来拿！",
  link: window.location.href.split("#")[0],
  imgUrl: "https://img.kaikeba.com/41035102219102jcsj.png",
  /**
   *
   * @param title 分享给朋友title
   * @param friend_title 分享到朋友圈title
   * @param describe 分享描述
   * @param shareImgKey 分享中图片的key
   * @param shareLink 分享出去的连接
   */
  init: function(
    shareLink,
    venueSignInFn,
    isWxServiceFn,
    kuickDealonBehaviour,
    shareTitle,
    shareDesc
  ) {
    let sendData = {
      url: encodeURIComponent(window.location.href)
    };
    let shareLinkUrl = shareLink;
    if (shareLink.indexOf("code") >= 0) {
      shareLinkUrl = urlDelP(shareLinkUrl, "code");
    }
    if (shareLink.indexOf("state") >= 0) {
      shareLinkUrl = urlDelP(shareLinkUrl, "state");
    }
    if (shareLink.indexOf("appId") >= 0) {
      shareLinkUrl = urlDelP(shareLinkUrl, "appId");
    }

    request
      .get(`/open/wechat/jsapisign?url=${sendData.url}`)
      .then(res => {
        let resData = res.data;
        wx.config({
          debug: false,
          appId: resData.appId,
          timestamp: resData.timestamp,
          nonceStr: resData.nonceStr,
          signature: resData.signature,
          jsApiList: [
            "onMenuShareAppMessage", // 分享给朋友
            "onMenuShareTimeline" // 分享到朋友圈
          ]
        });
        wx.ready(function() {
          wx.onMenuShareAppMessage({
            title: shareTitle,
            desc: shareDesc,
            link: shareLinkUrl,
            imgUrl: share.imgUrl,
            success: function() {
              kuickDealonBehaviour("venue_shared_weixin", "分享完成");
              venueSignInFn();
              isWxServiceFn();
            }
          });
          wx.onMenuShareTimeline({
            title: shareTitle,
            link: shareLinkUrl,
            imgUrl: share.imgUrl,
            success: function() {
              kuickDealonBehaviour("venue_shared_weixin", "分享完成");
              venueSignInFn();
              isWxServiceFn();
            }
          });
        });
      })
      .catch(err => {
        console.log(err, "鉴权失败");
      });
  }
};

````

官方文档：https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html#5



4 二维码canvas转img

```
  canvasImg = () => {
    let Qr = document.getElementById("Qrcode");
    let alink = document.createElement("img");
    alink.id = "QrImg";
    alink.src = Qr.toDataURL("image/png");
    Qr.parentNode.replaceChild(alink, Qr);
  };
```


5 移动端图片的loading处理

使用imgx插件 图片渐进式加载
地址：https://www.npmjs.com/package/imgx

使用如下方法提前加载,在图片的url后拼接

![20200103174311](http://f.shudong.wang/starkwang/20200103174311.png)

React在render时禁止操作demo，否则会引起重新渲染，导致dom重复更新形成死循环


6 快推埋点的处理

快推的埋点需要在App.js中引入一段js文本，如下

```
import { currentEnv } from "./env";
let appKey, env;
if (["pre", "prod"].includes(currentEnv)) {
  appKey = `5d6526d7-3c9f-460b-b6cf-ba75397ce1ac`;
  env = "";
} else if ("test" === currentEnv) {
  appKey = `10bc337c-8863-4a4e-a8f8-74e09ab6bbb3`;
  env = "-test2";
}

var _kuickDeal = _kuickDeal || [];
window._kuickDeal = _kuickDeal;

(function() {
  var _dealProtocol =
    "https:" == document.location.protocol ? " https://" : " http://";
  var _sdkURL = _dealProtocol + `deal${env}.kuick.cn/sdk/v1/`;

  _kuickDeal.push(["SDK_URL", _sdkURL]);
  _kuickDeal.push([
    "KUICK_API_URL",
    _dealProtocol + `api${env}.kuick.cn/api/v1.0`
  ]);
  _kuickDeal.push([
    "DEAL_API_URL",
    _dealProtocol + `deal-api${env}.kuick.cn/api/v1.0`
  ]);
  _kuickDeal.push(["APP_KEY", appKey]);

  _kuickDeal.push(["LOG_LEVEL", "2"]);
  _kuickDeal.push(["LOG_LEVEL", "2"]);

  _kuickDeal.push(["DISABLE_SENTRY", true]);
  let UTM_SOURCE = GetQueryString("utm_source");
  _kuickDeal.push(["UTM_SOURCE", UTM_SOURCE]);
  (function() {
    // if(typeof define === 'function' && define.amd) {
    //     require([_sdkURL + 'kuickdeal-pc.min.js'], function(kd){
    //         window.kuickDeal = kd;
    //     });
    // } else {

    var deal = document.getElementById("Kuick");

    deal.type = "text/javascript";
    deal.async = false;
    deal.src = _sdkURL + "kuickdeal-pc.min.js";
    // var s = document.getElementsByTagName('script')[0];
    // console.log(s)
    // s.parentNode.insertBefore(deal, s);
    // }
  })();
})();
function GetQueryString(name) {
  var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
  var r = window.location.search.substr(1).match(reg); //获取url中"?"符后的字符串并正则匹配
  var context = "";
  if (r != null) context = r[2];
  reg = null;
  r = null;
  return context == null || context == "" || context == "undefined"
    ? ""
    : context;
}

```


快推会给window对象注入一个_kuickDeal数组，主要的作用是存储他需要读取的数据
还会注入一个kuickDeal对象 里边挂载了一些快推的方法

在程序运行的位置调用快推的方法 进行埋点检测

具体文档：https://deal-opendoc.kuick.cn/sdk/pc/



gio埋点 直接在index.html插入以下代码

```
<script type="text/javascript">
      var WOrigin = window.location.origin;
      var GioAppKey = "";
      if (WOrigin.indexOf("test") === -1) {
        GioAppKey = "9a4aeaa633187356";
      } else {
        GioAppKey = "9fecfdc6624d48f8";
      }
      !(function(e, t, n, g, i) {
        (e[i] =
          e[i] ||
          function() {
            (e[i].q = e[i].q || []).push(arguments);
          }),
          (n = t.createElement("script")),
          (tag = t.getElementsByTagName("script")[0]),
          (n.async = 1),
          (n.src =
            ("https:" == document.location.protocol ? "https://" : "http://") +
            g),
          tag.parentNode.insertBefore(n, tag);
      })(window, document, "script", "assets.giocdn.com/2.1/gio.js", "gio");
      gio("init", GioAppKey, {});
      //custom page code begin here

      //custom page code end here

      gio("send");
    </script>
```